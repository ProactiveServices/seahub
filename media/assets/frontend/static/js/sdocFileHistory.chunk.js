(this["webpackJsonpseahub-frontend"]=this["webpackJsonpseahub-frontend"]||[]).push([[17],{1693:function(e,t,n){n(73),e.exports=n(1827)},1725:function(e,t,n){},1726:function(e,t,n){},1727:function(e,t,n){},1827:function(e,t,n){"use strict";n.r(t);var s=n(3),i=n(4),o=n(6),a=n(7),r=n(2),c=n.n(r),l=n(33),h=n.n(l),d=n(1847),u=n(34),f=n.n(u),m=n(182),j=n(8),g=n(1),b=n(21),p=(n(1725),n(0)),v=function(e){Object(o.a)(n,e);var t=Object(a.a)(n);function n(){var e;Object(s.a)(this,n);for(var i=arguments.length,o=new Array(i),a=0;a<i;a++)o[a]=arguments[a];return(e=t.call.apply(t,[this].concat(o))).onBackClick=function(e){e.preventDefault(),window.history.back()},e}return Object(i.a)(n,[{key:"render",value:function(){return Object(p.jsx)("div",{className:"go-back",onClick:this.onBackClick,children:Object(p.jsx)("span",{className:"fas fa-chevron-left"})})}}]),n}(r.Component),x=v,O=n(48),y=n(12),w=n.n(y);w.a.locale(window.app.config.lang);var C=function e(t){Object(s.a)(this,e),this.commitId=t.commit_id||void 0,this.ctime=t.ctime?w()(t.ctime).format("YYYY-MM-DD HH:mm"):"",this.creatorName=t.creator_name||"",this.size=t.size||0,this.revRenamedOldPath=t.rev_renamed_old_path||"",this.revFileId=t.rev_file_id||"",this.path=t.path||"",this.description=t.description||""},S=n(5),V=n(108),N=n(10),I=n(326),M=n(329),k=n(328),H=n(200),L=n(110),D=(n(561),function(e){Object(o.a)(n,e);var t=Object(a.a)(n);function n(e){var i;return Object(s.a)(this,n),(i=t.call(this,e)).onMouseEnter=function(){var e=i.props,t=e.currentVersion,n=e.historyVersion;t.commitId!==n.commitId&&i.setState({isShowOperationIcon:!0})},i.onMouseLeave=function(){var e=i.props,t=e.currentVersion,n=e.historyVersion;t.commitId!==n.commitId&&i.setState({isShowOperationIcon:!1})},i.onToggleClick=function(e){i.setState({isMenuShow:!i.state.isMenuShow})},i.onClick=function(){i.setState({isShowOperationIcon:!1});var e=i.props,t=e.currentVersion,n=e.historyVersion;t.commitId!==n.commitId&&i.props.onSelectHistoryVersion(n)},i.onRestore=function(){var e=i.props.historyVersion;i.props.onRestore(e)},i.onItemDownload=function(){},i.state={isShowOperationIcon:!1,isMenuShow:!1},i}return Object(i.a)(n,[{key:"render",value:function(){var e=this.props,t=e.currentVersion,n=e.historyVersion;if(!t||!n)return null;var s=n.ctime,i=n.commitId,o=n.creatorName,a=n.revFileId,r=i===t.commitId,c=L.a.getUrl({type:"download_historic_file",filePath:g.qb,objID:a});return Object(p.jsxs)("li",{className:"history-list-item ".concat(r?"item-active":""),onMouseEnter:this.onMouseEnter,onMouseLeave:this.onMouseLeave,onClick:this.onClick,children:[Object(p.jsxs)("div",{className:"history-info",children:[Object(p.jsx)("div",{className:"time",children:s}),Object(p.jsxs)("div",{className:"owner",children:[Object(p.jsx)("span",{className:"squire-icon"}),Object(p.jsx)("span",{children:o})]})]}),Object(p.jsx)("div",{className:"history-operation",children:Object(p.jsxs)(I.a,{isOpen:this.state.isMenuShow,toggle:this.onToggleClick,children:[Object(p.jsx)(M.a,{tag:"a",className:"fas fa-ellipsis-v ".concat(this.state.isShowOperationIcon||r?"":"invisible"),"data-toggle":"dropdown","aria-expanded":this.state.isMenuShow,alt:Object(g.ub)("More Operations")}),Object(p.jsxs)(k.a,{children:[0!==this.props.index&&Object(p.jsx)(H.a,{onClick:this.onItemRestore,children:Object(g.ub)("Restore")}),Object(p.jsx)(H.a,{tag:"a",href:c,onClick:this.onItemDownLoad,children:Object(g.ub)("Download")})]})]})})]})}}]),n}(c.a.Component));n(1726);var R=function(e){var t=e.onChange,n=e.checked,s=e.placeholder,i=e.disabled,o=e.className,a=e.size;return Object(p.jsx)("div",{className:f()("seahub-switch position-relative",o,a),children:Object(p.jsxs)("label",{className:"custom-switch",children:[Object(p.jsx)("input",{className:"custom-switch-input",type:"checkbox",checked:n,onChange:t,name:"custom-switch-checkbox",disabled:i}),Object(p.jsx)("span",{className:"custom-switch-description text-truncate",children:s}),Object(p.jsx)("span",{className:"custom-switch-indicator"})]})})},E=function(e){Object(o.a)(n,e);var t=Object(a.a)(n);function n(e){var i;return Object(s.a)(this,n),(i=t.call(this,e)).init=function(){i.hasMore=!0,i.nextCommit="",i.filePath="",i.oldFilePath=""},i.listHistoryVersions=function(e,t,n,s){j.a.listOldFileHistoryRecords(e,t,n).then((function(e){var t=e.data;t?i.updateHistoryVersions(t,s):i.setState({isLoading:!1,errorMessage:"There is an error in server."})})).catch((function(e){var t=S.a.getErrorMsg(e,!0);i.setState({isLoading:!1,errorMessage:t})}))},i.onScrollHandler=function(e){var t=e.target.clientHeight,n=e.target.scrollHeight;t+e.target.scrollTop+1>=n&&i.hasMore&&i.nextCommit&&i.loadMore()},i.loadMore=function(){i.state.isLoading||i.setState({isLoading:!0},(function(){var e=i.oldFilePath||i.filePath;i.listHistoryVersions(g.yb,e,i.nextCommit)}))},i.restoreVersion=function(e){var t=e.commitId,n=e.path;V.a.revertFile(n,t).then((function(e){e.data.success&&(i.init(),i.setState({isLoading:!0,historyVersions:[],errorMessage:""},(function(){i.listHistoryVersions(g.yb,g.qb)})))})).catch((function(e){var t=S.a.getErrorMsg(e,!0);N.a.danger(Object(g.ub)(t))}))},i.onSelectHistoryVersion=function(e){if(i.props.isShowChanges){var t=i.state.historyVersions,n=t.findIndex((function(t){return t.commitId===e.commitId}));i.props.onSelectHistoryVersion(e,t[n+1])}else i.props.onSelectHistoryVersion(e)},i.renderHistoryVersions=function(){var e=i.state,t=e.isLoading,n=e.historyVersions,s=e.errorMessage;return 0===n.length?t?Object(p.jsx)("div",{className:"h-100 w-100 d-flex align-items-center justify-content-center",children:Object(p.jsx)(b.a,{})}):s?Object(p.jsx)("div",{className:"h-100 w-100 d-flex align-items-center justify-content-center error-message",children:Object(g.ub)(s)}):Object(p.jsx)("div",{className:"h-100 w-100 d-flex align-items-center justify-content-center empty-tip-color",children:Object(g.ub)("No_historical_versions")}):Object(p.jsxs)(p.Fragment,{children:[n.map((function(e,t){return Object(p.jsx)(D,{index:t,currentVersion:i.props.currentVersion,historyVersion:e,onSelectHistoryVersion:i.onSelectHistoryVersion,onRestore:i.restoreVersion},e.commitId)})),t&&Object(p.jsx)("div",{className:"loading-more d-flex align-items-center justify-content-center w-100",children:Object(p.jsx)(b.a,{})})]})},i.onShowChanges=function(){var e=i.props,t=e.isShowChanges,n=e.currentVersion,s=i.state.historyVersions,o=s.findIndex((function(e){return e.commitId===n.commitId})),a=s[o+1];i.props.onShowChanges(!t,a)},i.state={isLoading:!0,historyVersions:[],errorMessage:""},i.init(),i}return Object(i.a)(n,[{key:"componentDidMount",value:function(){var e=this;this.listHistoryVersions(g.yb,g.qb,this.nextCommit,(function(t,n){e.props.onSelectHistoryVersion(t,n)}))}},{key:"updateHistoryVersions",value:function(e,t){var n=e.data?e.data.length:0;if(this.nextCommit=e.next_start_commit||"",n){var s=e.data.map((function(e){return new C(e)}));this.filePath=s[n-1].path,this.oldFilePath=s[n-1].revRenamedOldPath;var i=[].concat(Object(O.a)(this.state.historyVersions),Object(O.a)(s));this.setState({historyVersions:i,isLoading:!1,errorMessage:""},(function(){t&&t(i[0],i[1])}))}else this.nextCommit?this.listHistoryVersions(g.yb,g.qb,this.nextCommit):(this.hasMore=!1,this.setState({isLoading:!1,errorMessage:""}))}},{key:"render",value:function(){var e=this.state.historyVersions;return Object(p.jsxs)("div",{className:"sdoc-file-history-panel h-100 o-hidden d-flex flex-column",children:[Object(p.jsx)("div",{className:"sdoc-file-history-select-range",children:Object(p.jsx)("div",{className:"sdoc-file-history-select-range-title",children:Object(g.ub)("History Versions")})}),Object(p.jsx)("div",{className:f()("sdoc-file-history-versions",{"o-hidden":0===e.length}),onScroll:this.onScrollHandler,children:this.renderHistoryVersions()}),Object(p.jsx)("div",{className:"sdoc-file-history-diff-switch d-flex align-items-center",children:Object(p.jsx)(R,{checked:this.props.isShowChanges,placeholder:Object(g.ub)("Show changes"),className:"sdoc-history-show-changes w-100",size:"small",onChange:this.onShowChanges})})]})}}]),n}(r.Component),F=(n(204),n(1727),window.app.config),_=F.serviceURL,P=F.avatarURL,T=F.siteRoot,U=window.app.pageOptions,q=U.username,z=U.name,Y=window.fileHistory.pageOptions,B=Y.repoID,A=Y.fileName,J=Y.filePath,G=Y.docUuid,K=Y.assetsUrl;window.seafile={repoID:B,docPath:J,docName:A,docUuid:G,isOpenSocket:!1,serviceUrl:_,name:z,username:q,avatarURL:P,siteRoot:T,assetsUrl:K};var Q=function(e){Object(o.a)(n,e);var t=Object(a.a)(n);function n(e){var i;Object(s.a)(this,n),(i=t.call(this,e)).onSelectHistoryVersion=function(e,t){i.setState({isLoading:!0,currentVersion:e}),j.a.getFileRevision(g.yb,e.commitId,e.path).then((function(e){return j.a.getFileContent(e.data)})).then((function(e){var n=e.data;t?j.a.getFileRevision(g.yb,t.commitId,t.path).then((function(e){return j.a.getFileContent(e.data)})).then((function(e){var t=e.data;i.setContent(n,t)})).catch((function(e){var t=S.a.getErrorMsg(e,!0);N.a.danger(Object(g.ub)(t)),i.setContent(n,"")})):i.setContent(n,"")})).catch((function(e){var t=S.a.getErrorMsg(e,!0);N.a.danger(Object(g.ub)(t)),i.setContent("","")}))},i.setContent=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";i.setState({currentVersionContent:e,lastVersionContent:t,isLoading:!1,changes:[],currentDiffIndex:0})},i.onShowChanges=function(e,t){if(e&&t){var n=i.state.currentVersionContent;i.setState({isLoading:!0},(function(){localStorage.setItem("seahub-sdoc-history-show-changes",e+""),j.a.getFileRevision(g.yb,t.commitId,t.path).then((function(e){return j.a.getFileContent(e.data)})).then((function(t){var s=t.data;i.setContent(n,s),i.setState({isShowChanges:e})})).catch((function(t){var s=S.a.getErrorMsg(t,!0);N.a.danger(Object(g.ub)(s)),i.setContent(n,""),i.setState({isShowChanges:e})}))}))}else i.setState({isShowChanges:e},(function(){localStorage.setItem("seahub-sdoc-history-show-changes",e+"")}))},i.setDiffCount=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{value:[],changes:[]},t=e.changes;i.setState({changes:t,currentDiffIndex:0})},i.jumpToElement=function(e){i.setState({currentDiffIndex:e},(function(){var e=i.state,t=e.currentDiffIndex,n=e.changes[t],s=document.querySelectorAll("[data-id=".concat(n,"]"))[0];s&&(i.historyContentRef.scrollTop=s.offsetTop-10)}))},i.lastChange=function(){var e=i.state,t=e.currentDiffIndex,n=e.changes;0!==t?i.jumpToElement(t-1):i.jumpToElement(n.length-1)},i.nextChange=function(){var e=i.state,t=e.currentDiffIndex;t!==e.changes.length-1?i.jumpToElement(t+1):i.jumpToElement(0)};var o="false"!==localStorage.getItem("seahub-sdoc-history-show-changes");return i.state={isLoading:!0,isShowChanges:o,currentVersion:{},currentVersionContent:"",lastVersionContent:"",changes:[],currentDiffIndex:0},i}return Object(i.a)(n,[{key:"render",value:function(){var e=this,t=this.state,n=t.currentVersion,s=t.isShowChanges,i=t.currentVersionContent,o=t.lastVersionContent,a=t.isLoading,r=t.changes,c=t.currentDiffIndex,l=r?r.length:0,h=s&&l>0;return Object(p.jsxs)("div",{className:"sdoc-file-history d-flex h-100 w-100 o-hidden",children:[Object(p.jsxs)("div",{className:"sdoc-file-history-container d-flex flex-column",children:[Object(p.jsxs)("div",{className:"sdoc-file-history-header pt-2 pb-2 pl-4 pr-4 d-flex justify-content-between w-100 o-hidden",children:[Object(p.jsxs)("div",{className:f()("sdoc-file-history-header-left d-flex align-items-center o-hidden",{"pr-4":h}),children:[Object(p.jsx)(x,{}),Object(p.jsx)("div",{className:"file-name text-truncate",children:A})]}),h&&Object(p.jsx)("div",{className:"sdoc-file-history-header-right d-flex align-items-center",children:Object(p.jsxs)("div",{className:"sdoc-file-changes-container d-flex align-items-center ",children:[Object(p.jsx)("div",{className:"sdoc-file-changes-tip d-flex align-items-center justify-content-center pl-2 pr-2",children:"".concat(Object(g.ub)("Changes")," ").concat(c+1,"/").concat(l)}),Object(p.jsx)("div",{className:"sdoc-file-changes-divider"}),Object(p.jsx)("div",{className:"sdoc-file-changes-last d-flex align-items-center justify-content-center",id:"sdoc-file-changes-last",onClick:this.lastChange,children:Object(p.jsx)("span",{className:"fas fa-chevron-up"})}),Object(p.jsx)("div",{className:"sdoc-file-changes-divider"}),Object(p.jsx)("div",{className:"sdoc-file-changes-next d-flex align-items-center justify-content-center",id:"sdoc-file-changes-next",onClick:this.nextChange,children:Object(p.jsx)("span",{className:"fas fa-chevron-down"})}),Object(p.jsx)(d.a,{placement:"bottom",target:"sdoc-file-changes-last",children:Object(g.ub)("Last modification")}),Object(p.jsx)(d.a,{placement:"bottom",target:"sdoc-file-changes-next",children:Object(g.ub)("Next modification")})]})})]}),Object(p.jsx)("div",{className:"sdoc-file-history-content f-flex flex-column",ref:function(t){return e.historyContentRef=t},children:a?Object(p.jsx)("div",{className:"sdoc-file-history-viewer d-flex align-items-center justify-content-center",children:Object(p.jsx)(b.a,{})}):Object(p.jsx)(m.a,{currentContent:i,lastContent:s?o:"",didMountCallback:this.setDiffCount})})]}),Object(p.jsx)(E,{isShowChanges:s,currentVersion:n,onSelectHistoryVersion:this.onSelectHistoryVersion,onShowChanges:this.onShowChanges})]})}}]),n}(c.a.Component);h.a.render(Object(p.jsx)(Q,{}),document.getElementById("wrapper"))},561:function(e,t,n){}},[[1693,1,0]]]);
//# sourceMappingURL=sdocFileHistory.chunk.js.map